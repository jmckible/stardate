name: Scheduled Tasks

on:
  schedule:
    # Daily recurring transactions at 5:30 AM PST (13:30 UTC)
    # Runs at 13:30 UTC every day (off :30 to avoid high-load periods)
    - cron: '30 13 * * *'
    
    # Account funding on 1st and 15th at 5:30 AM PST (13:30 UTC)
    # Runs at 13:30 UTC on the 1st and 15th of every month
    - cron: '30 13 1,15 * *'
  
  # Allow manual triggering for testing
  workflow_dispatch:
    inputs:
      task:
        description: 'Which task to run'
        required: true
        type: choice
        options:
          - recur
          - accounts:fund
          - both

jobs:
  run-recur:
    name: Daily Recurring Transactions
    runs-on: ubuntu-latest
    # Run on daily schedule OR manual trigger with 'recur' or 'both'
    if: |
      (github.event.schedule == '30 13 * * *') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.task == 'recur' || github.event.inputs.task == 'both'))
    steps:
      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Run recurring transaction task
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "=== Daily Recurring Transactions ==="
          echo "Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          # Wake up the machine with an HTTP request
          echo "Waking up application..."
          curl -f https://stardate.fly.dev/ || true
          sleep 5
          
          # Now SSH in and run the task
          echo ""
          echo "Running task..."
          flyctl ssh console -a stardate -C "bin/rails recur"
          
          echo ""
          echo "=== Task Completed ==="

  run-accounts-fund:
    name: Account Funding (1st & 15th)
    runs-on: ubuntu-latest
    # Run on 1st/15th schedule OR manual trigger with 'accounts:fund' or 'both'
    if: |
      (github.event.schedule == '30 13 1,15 * *') ||
      (github.event_name == 'workflow_dispatch' && (github.event.inputs.task == 'accounts:fund' || github.event.inputs.task == 'both'))
    steps:
      - name: Install flyctl
        uses: superfly/flyctl-actions/setup-flyctl@master
      
      - name: Run account funding task
        env:
          FLY_API_TOKEN: ${{ secrets.FLY_API_TOKEN }}
        run: |
          echo "=== Account Funding (1st & 15th) ==="
          echo "Date: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo ""
          
          # Wake up the machine with an HTTP request
          echo "Waking up application..."
          curl -f https://stardate.fly.dev/ || true
          sleep 5
          
          # Now SSH in and run the task
          echo ""
          echo "Running task..."
          flyctl ssh console -a stardate -C "bin/rails accounts:fund"
          
          echo ""
          echo "=== Task Completed ==="
